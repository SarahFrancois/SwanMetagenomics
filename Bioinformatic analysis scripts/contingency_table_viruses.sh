#! /usr/bin/env bash
#
# Author: Sarah FranÃ§ois
# Date of last update: 2019-10-07
#
# Usage: ./contingency_table_viruses.sh SAMPLE_LIST
#
# EXAMPLE: ./contingency_table_viruses.sh sample_list.txt
#

# SET VARIABLES
SAMPLELIST=$1

# DATA FORMATTING
cat $SAMPLELIST | while read line
do
  # Generates one file per sample, from the SAM file that was obtained after mapping using the suffix added to each read during the quality filtering step
  grep $line Mapping/mapped_reads.sam > SAMPLE$line.tab1
  # Keeps the column containing headers
  awk '{print $3}' SAMPLE$line.tab1 > SAMPLE$line.tab2
done

# CONTINGENCY TABLE CREATION
  # Transformation of multiple files into one contingency table
awk -F" " 'FNR==1{c++}
             {counts[$1,c]++; keys[$1]}
          END{print "Taxonomy UTMF0242 UTMF0244 UTMF0246 UTMF0273 UTMF0973 UTMF0975 UTMF0978 UTMF0980 UTMF0982 UTMF0984 UTMF0985 UTMF0990 UTMF0991 UTMF0993 UTMF1000 UTMF1004 UTMF1005 UTMF1007 UTMF1010 UTMF1016 UTMF1017 UTMF1019 UTMF1020 UTMF1021 UTMF1022 UTMF1027 UTMF1031 UTMF1032 UTMF1033 UTMF1034 UTMF1035 UTMF1036 UTMF1038 UTMF1041 UTMF1046 UTMF1049 UTMF1050 UTMF1056 UTMF1058 UTMF1059 UTMF1062 UTMF1064 UTMF1065 UTMF1067 UTMF1071 UTMF1078 UTMF1079 UTMF1086 UTMF1088 UTMF1090 UTMF1095 UTMF1100 UTMF1101 UTMF1105 UTMF1106 UTMF1107 UTMF1108 UTMF1109 UTMF1111 UTMF1113 UTMF1122 UTMF1123 UTMF1129 UTMF1130 UTMF1133 UTMF1135 UTMF1136 UTMF1138 UTMF1141 UTMF1154 UTMF1155 UTMF1160 UTMF1166 UTMF1167 UTMF1186 UTMF1189 UTMF1190 UTMF1193 UTMF1194 UTMF1196 UTMF1198 UTMF1206 UTMF1208 UTMF1209 UTMF1210 UTMF1211 UTMF1233 UTMF1236 UTMF1246 UTMF1255 UTMF1260 UTMF1261 UTMF1266 UTMF1269 UTMF1271 UTMF1273 UTMF1277 UTMF1279 UTMF1282 UTMF1285 UTMF1287 UTMF1289 UTMF1291 UTMF1294 UTMF1297 UTMF1298 UTMF1300 UTMF1301 UTMF1307 UTMF1310 UTMF1311 UTMF1313 UTMF1324 UTMF1325 UTMF1341 UTMF1348 UTMF1355 UTMF1356 UTMF1358 UTMF1366 UTMF1367 UTMF1374 UTMF1375 UTMF1382 UTMF1385 UTMF1388 UTMF1389 UTMF1393 UTMF1394 UTMF1395 UTMF1409 UTMF1410 UTMF1420 UTMF1422 UTMF1424 UTMF1427 UTMF1428 UTMF1429 UTMF1430 UTMF1434 UTMF1436 UTMF1437 UTMF1445 UTMF1446 UTMF1453 UTMF1455 UTMF1458 UTMF1483 UTMF1484 UTMF1485 UTMF1488 UTMF1489 UTMF1490 UTMF1491 UTMF1492 UTMF1495 UTMF1496 UTMF1497 UTMF1498 UTMF1501 UTMF1502 UTMF1503 UTMF1504 UTMF1505 UTMF1507 UTMF1509 UTMF1513 UTMF1515 UTMF1519 UTMF1523 UTMF1525 UTMF1541 UTMF1542 UTMF1543 UTMF1547 UTMF1549 UTMF1552 UTMF1554 UTMF1556 UTMF1568 UTMF1569 UTMF1576 UTMF1577 UTMF1578 UTMF1579 UTMF1581 UTMF1583 UTMF1586 UTMF1588 UTMF1592 UTMF1597 UTMF1598 UTMF1608 UTMF1609 UTMF1610 UTMF1613 UTMF1617 UTMF1620 UTMF1625 UTMF1627 UTMF1628 UTMF1629 UTMF1640 UTMF1646 UTMF1648 UTMF1650 UTMF1658 UTMF1661 UTMF1663 UTMF1667 UTMF1670 UTMF1671 UTMF1672 UTMF1673 UTMF1676 UTMF1677 UTMF1680 UTMF1681 UTMF1685 UTMF1694 UTMF1695 UTMF1698 UTMF1701 UTMF1705 UTMF1709 UTMF1713 UTMF1714";
              for(k in keys) {printf "%s ",k;
                              for(i=1;i<=c;i++) printf "%s ", counts[k,i]+0;
                              print ""}}' SAMPLE{0242,0244,0246,0273,0973,0975,0978,0980,0982,0984,0985,0990,0991,0993,1000,1004,1005,1007,1010,1016,1017,1019,1020,1021,1022,1027,1031,1032,1033,1034,1035,1036,1038,1041,1046,1049,1050,1056,1058,1059,1062,1064,1065,1067,1071,1078,1079,1086,1088,1090,1095,1100,1101,1105,1106,1107,1108,1109,1111,1113,1122,1123,1129,1130,1133,1135,1136,1138,1141,1154,1155,1160,1166,1167,1186,1189,1190,1193,1194,1196,1198,1206,1208,1209,1210,1211,1233,1236,1246,1255,1260,1261,1266,1269,1271,1273,1277,1279,1282,1285,1287,1289,1291,1294,1297,1298,1300,1301,1307,1310,1311,1313,1324,1325,1341,1348,1355,1356,1358,1366,1367,1374,1375,1382,1385,1388,1389,1393,1394,1395,1409,1410,1420,1422,1424,1427,1428,1429,1430,1434,1436,1437,1445,1446,1453,1455,1458,1483,1484,1485,1488,1489,1490,1491,1492,1495,1496,1497,1498,1501,1502,1503,1504,1505,1507,1509,1513,1515,1519,1523,1525,1541,1542,1543,1547,1549,1552,1554,1556,1568,1569,1576,1577,1578,1579,1581,1583,1586,1588,1592,1597,1598,1608,1609,1610,1613,1617,1620,1625,1627,1628,1629,1640,1646,1648,1650,1658,1661,1663,1667,1670,1671,1672,1673,1676,1677,1680,1681,1685,1694,1695,1698,1701,1705,1709,1713,1714}.tab2 |
  column -t -s ":" > contingency_table_v1
  # Conversion to tabular file
 tr " " "\t" < contingency_table_v1 > contingency_table.tab

rm contingency_table_v1
rm *.tab1
rm *.tab2

  set -o errexit   # abort on nonzero exitstatus
  set -o nounset   # abort on unbound variable
  set -o pipefail  # don't hide errors within pipes
#set -o xtrace          # Trace the execution of the script (debug)
